graph TB
    subgraph Internet["ğŸŒ Internet"]
        User["ğŸ‘¤ Usuario"]
        Developer["ğŸ’» Desarrollador"]
    end

    subgraph AWS["â˜ï¸ AWS Cloud - RegiÃ³n us-east-1"]
        subgraph VPC["ğŸ”· VPC (Red Virtual Privada)"]
            subgraph PublicSubnet["ğŸŸ¢ Subred PÃºblica (Accesible desde Internet)"]
                APIGateway["ğŸšª API Gateway<br/>â”€â”€â”€â”€â”€â”€â”€<br/>REST API<br/>Ãšnico Punto de Entrada<br/>API Key + CORS<br/>IntegraciÃ³n: AWS_PROXY"]
            end

            subgraph PrivateSubnet["ğŸ”µ Subred Privada (Sin Acceso Directo)"]
                Lambda["âš¡ Funciones Lambda<br/>â”€â”€â”€â”€â”€â”€â”€<br/>5 funciones independientes:<br/>â€¢ CrearNota (POST /notes)<br/>â€¢ ObtenerNota (GET /notes/{id})<br/>â€¢ ListarNotas (GET /notes)<br/>â€¢ ActualizarNota (PUT /notes/{id})<br/>â€¢ EliminarNota (DELETE /notes/{id})<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Python 3.11 | 128-256MB"]
            end
        end

        subgraph Services["ğŸ”§ Servicios AWS (Red Privada)"]
            S3["ğŸ—‚ï¸ Amazon S3<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Bucket: notes-lambda-deployment<br/>CÃ³digo Lambda (.zip files)"]
            
            DynamoDB["ğŸ—„ï¸ DynamoDB<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Tabla: Notes<br/>PK: note_id<br/>Modo: PAY_PER_REQUEST"]
            
            IAM["ğŸ” IAM Role<br/>â”€â”€â”€â”€â”€â”€â”€<br/>LabRole<br/>Permisos Lambda + DynamoDB"]
            
            CloudWatch["ğŸ“Š CloudWatch<br/>â”€â”€â”€â”€â”€â”€â”€<br/>Logs: /aws/lambda/*<br/>MÃ©tricas por funciÃ³n"]
        end
    end

    subgraph Pipeline["ğŸš€ Pipeline - OpciÃ³n B"]
        Source["ğŸ“ CÃ³digo Fuente<br/>â”€â”€â”€â”€â”€â”€â”€<br/>app-lambda/*/handler.py<br/>shared/ (models + utils)<br/>requirements.txt"]
        
        Build["ğŸ“¦ Lambda Package<br/>â”€â”€â”€â”€â”€â”€â”€<br/>package-lambdas.py<br/>Crea 5 archivos .zip<br/>+ dependencias + shared/"]
        
        Deploy["ğŸ¯ CloudFormation<br/>â”€â”€â”€â”€â”€â”€â”€<br/>04-lambda-option-b.yml<br/>Scripts: deploy-lambda.py<br/>Sube cÃ³digo a S3"]
    end

    %% === FLUJO USUARIO (RUNTIME) ===
    User ==>|"ğŸ”’ HTTPS + API Key<br/>(Ãšnica Entrada)"| APIGateway
    
    APIGateway -->|"Endpoints CRUD<br/>POST/GET/PUT/DELETE"| Lambda
    
    Lambda -->|"Operaciones DynamoDB<br/>PutItem/GetItem/Scan/UpdateItem/DeleteItem"| DynamoDB

    %% === DEPENDENCIAS ===
    Lambda -.->|"Carga cÃ³digo<br/>al ejecutar"| S3
    IAM -.->|"Concede permisos"| Lambda
    IAM -.->|"Permite acceso"| DynamoDB
    Lambda -.->|"EnvÃ­a logs"| CloudWatch
    APIGateway -.->|"MÃ©tricas API"| CloudWatch

    %% === PIPELINE (BUILD & DEPLOY) ===
    Developer -.->|"Git Push"| Source
    Source --> Build
    Build -->|"Sube 5 archivos .zip"| S3
    Deploy -->|"Crea infraestructura:<br/>â€¢ 5 funciones Lambda<br/>â€¢ API Gateway<br/>â€¢ Permisos IAM"| AWS

    %% === BLOQUEOS DE SEGURIDAD ===
    User x-.-x|"âŒ BLOQUEADO<br/>Sin ruta directa"| PrivateSubnet
    User x-.-x|"âŒ BLOQUEADO<br/>Sin ruta directa"| Services

    %% Estilos
    classDef internet fill:#e3f2fd,stroke:#1976d2,stroke-width:4px
    classDef publicZone fill:#c8e6c9,stroke:#388e3c,stroke-width:3px
    classDef privateZone fill:#ffccbc,stroke:#d84315,stroke-width:3px
    classDef gateway fill:#ff9900,stroke:#232f3e,stroke-width:4px,color:#000
    classDef lambda fill:#ff9900,stroke:#e65100,stroke-width:3px,color:#000
    classDef storage fill:#1565c0,stroke:#0d47a1,stroke-width:2px,color:#fff
    classDef database fill:#4a148c,stroke:#6a1b9a,stroke-width:2px,color:#fff
    classDef security fill:#c62828,stroke:#b71c1c,stroke-width:2px,color:#fff
    classDef monitor fill:#ff9800,stroke:#e65100,stroke-width:2px,color:#fff
    classDef pipeline fill:#6a1b9a,stroke:#4a148c,stroke-width:2px,color:#fff
    
    class Internet internet
    class User,Developer internet
    class PublicSubnet publicZone
    class PrivateSubnet,Services privateZone
    class APIGateway gateway
    class Lambda lambda
    class S3 storage
    class DynamoDB database
    class IAM security
    class CloudWatch monitor
    class Source,Build,Deploy pipeline